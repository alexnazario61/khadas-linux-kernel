From 197ddabeaca9cd6655c9bffecaead44a407346e8 Mon Sep 17 00:00:00 2001
From: hyphop <email2tema@gmail.com>
Date: Mon, 28 Oct 2019 07:12:28 +0300
Subject: [PATCH] dtbs krescue vims

---
 arch/arm64/boot/dts/amlogic/Makefile                  |  3 +++
 arch/arm64/boot/dts/amlogic/krescue-vim1.dts          |  6 ++++++
 arch/arm64/boot/dts/amlogic/krescue-vim2.dts          |  7 +++++++
 arch/arm64/boot/dts/amlogic/krescue-vim3-a311d.dts    |  6 ++++++
 arch/arm64/boot/dts/amlogic/krescue-vim3-s905d3.dts   |  5 +++++
 arch/arm64/boot/dts/amlogic/krescue-vim3-s922x.dts    |  5 +++++
 arch/arm64/boot/dts/amlogic/krescue-vim3.dtsi         | 19 +++++++++++++++++++
 arch/arm64/boot/dts/amlogic/krescue-vims.dtsi         | 12 ++++++++++++
 .../boot/dts/amlogic/meson-gxl-s905x-khadas-vim.dts   | 15 ++++++++++++---
 arch/arm64/boot/dts/amlogic/meson-gxm-khadas-vim2.dts |  4 ++--
 arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi    |  4 ++--
 11 files changed, 79 insertions(+), 7 deletions(-)
 create mode 100644 arch/arm64/boot/dts/amlogic/krescue-vim1.dts
 create mode 100644 arch/arm64/boot/dts/amlogic/krescue-vim2.dts
 create mode 100644 arch/arm64/boot/dts/amlogic/krescue-vim3-a311d.dts
 create mode 100644 arch/arm64/boot/dts/amlogic/krescue-vim3-s905d3.dts
 create mode 100644 arch/arm64/boot/dts/amlogic/krescue-vim3-s922x.dts
 create mode 100644 arch/arm64/boot/dts/amlogic/krescue-vim3.dtsi
 create mode 100644 arch/arm64/boot/dts/amlogic/krescue-vims.dtsi

diff --git a/arch/arm64/boot/dts/amlogic/Makefile b/arch/arm64/boot/dts/amlogic/Makefile
index 84afecb..6d4c2d1 100644
--- a/arch/arm64/boot/dts/amlogic/Makefile
+++ b/arch/arm64/boot/dts/amlogic/Makefile
@@ -36,3 +36,6 @@ dtb-$(CONFIG_ARCH_MESON) += meson-gxm-rbox-pro.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-gxm-vega-s96.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-sm1-sei610.dtb
 dtb-$(CONFIG_ARCH_MESON) += meson-sm1-khadas-vim3l.dtb
+dtb-$(CONFIG_ARCH_MESON) += krescue-vim3-a311d.dtb
+dtb-$(CONFIG_ARCH_MESON) += krescue-vim3-s922x.dtb
+dtb-$(CONFIG_ARCH_MESON) += krescue-vim3-s905d3.dtb
diff --git a/arch/arm64/boot/dts/amlogic/krescue-vim1.dts b/arch/arm64/boot/dts/amlogic/krescue-vim1.dts
new file mode 100644
index 0000000..36f2f15
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/krescue-vim1.dts
@@ -0,0 +1,6 @@
+
+// ## hyphop ##
+#include "meson-gxl-s905x-khadas-vim.dts"
+#include "krescue-vims.dtsi"
+
+
diff --git a/arch/arm64/boot/dts/amlogic/krescue-vim2.dts b/arch/arm64/boot/dts/amlogic/krescue-vim2.dts
new file mode 100644
index 0000000..b656704
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/krescue-vim2.dts
@@ -0,0 +1,7 @@
+
+// ## hyphop ##
+
+#include "meson-gxm-khadas-vim2.dts"
+#include "krescue-vims.dtsi"
+
+
diff --git a/arch/arm64/boot/dts/amlogic/krescue-vim3-a311d.dts b/arch/arm64/boot/dts/amlogic/krescue-vim3-a311d.dts
new file mode 100644
index 0000000..a2bd115
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/krescue-vim3-a311d.dts
@@ -0,0 +1,6 @@
+
+// ## hyphop ##
+
+#include "meson-g12b-a311d-khadas-vim3.dts"
+#include "krescue-vim3.dtsi"
+
diff --git a/arch/arm64/boot/dts/amlogic/krescue-vim3-s905d3.dts b/arch/arm64/boot/dts/amlogic/krescue-vim3-s905d3.dts
new file mode 100644
index 0000000..3ac8a60
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/krescue-vim3-s905d3.dts
@@ -0,0 +1,5 @@
+
+// ## hyphop ##
+
+#include "meson-sm1-khadas-vim3l.dts"
+#include "krescue-vim3.dtsi"
diff --git a/arch/arm64/boot/dts/amlogic/krescue-vim3-s922x.dts b/arch/arm64/boot/dts/amlogic/krescue-vim3-s922x.dts
new file mode 100644
index 0000000..dc2f7ab
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/krescue-vim3-s922x.dts
@@ -0,0 +1,5 @@
+
+// ## hyphop ##
+
+#include "meson-g12b-s922x-khadas-vim3.dts"
+#include "krescue-vim3.dtsi"
diff --git a/arch/arm64/boot/dts/amlogic/krescue-vim3.dtsi b/arch/arm64/boot/dts/amlogic/krescue-vim3.dtsi
new file mode 100644
index 0000000..9b7e92e
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/krescue-vim3.dtsi
@@ -0,0 +1,19 @@
+
+// VIM3 add
+
+&i2c3{
+    pinctrl-0 = <&i2c3_sck_a_pins>, <&i2c3_sda_a_pins>;
+    clock-frequency = <100000>; /* default 100k */
+    pinctrl-names = "default";
+    status = "okay";
+};
+
+
+&led_red{
+    default-state = "off";
+};
+
+&led_white{
+    default-state = "on";
+    linux,default-trigger = "heartbeat";
+};
diff --git a/arch/arm64/boot/dts/amlogic/krescue-vims.dtsi b/arch/arm64/boot/dts/amlogic/krescue-vims.dtsi
new file mode 100644
index 0000000..01e66fa
--- /dev/null
+++ b/arch/arm64/boot/dts/amlogic/krescue-vims.dtsi
@@ -0,0 +1,12 @@
+
+// common VIMS
+
+&key_p {
+    label = "Function";
+    linux,code = <KEY_FN>;
+};
+
+&key_f {
+    label = "Power";
+    linux,code = <KEY_POWER>;
+};
\ No newline at end of file
diff --git a/arch/arm64/boot/dts/amlogic/meson-gxl-s905x-khadas-vim.dts b/arch/arm64/boot/dts/amlogic/meson-gxl-s905x-khadas-vim.dts
index a8bc327..e93eb6a 100644
--- a/arch/arm64/boot/dts/amlogic/meson-gxl-s905x-khadas-vim.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-gxl-s905x-khadas-vim.dts
@@ -20,7 +20,7 @@
 		io-channel-names = "buttons";
 		keyup-threshold-microvolt = <1710000>;
 
-		button-function {
+		key_f: button-function {
 			label = "Function";
 			linux,code = <KEY_FN>;
 			press-threshold-microvolt = <10000>;
@@ -38,7 +38,7 @@
 		#size-cells = <0>;
 		poll-interval = <100>;
 
-		button@0 {
+		key_p: button@0 {
 			label = "power";
 			linux,code = <KEY_POWER>;
 			gpios = <&gpio_ao GPIOAO_2 GPIO_ACTIVE_LOW>;
@@ -48,7 +48,7 @@
 	pwmleds {
 		compatible = "pwm-leds";
 
-		power {
+		led_red: power {
 			label = "vim:red:power";
 			pwms = <&pwm_AO_ab 1 7812500 0>;
 			max-brightness = <255>;
@@ -232,6 +232,15 @@
 };
 
 &sd_emmc_a {
+
+//  vim1 vim2 wifi lost
+//  max-frequency = <50000000>;
+//  wifi work again but unstable
+//  max-frequency = <100000000>;
+//  stable freq
+
+	max-frequency = <60000000>;
+
 	brcmf: wifi@1 {
 		reg = <1>;
 		compatible = "brcm,bcm4329-fmac";
diff --git a/arch/arm64/boot/dts/amlogic/meson-gxm-khadas-vim2.dts b/arch/arm64/boot/dts/amlogic/meson-gxm-khadas-vim2.dts
index a1f4f8f..2fddcdc 100644
--- a/arch/arm64/boot/dts/amlogic/meson-gxm-khadas-vim2.dts
+++ b/arch/arm64/boot/dts/amlogic/meson-gxm-khadas-vim2.dts
@@ -36,7 +36,7 @@
 		io-channel-names = "buttons";
 		keyup-threshold-microvolt = <1710000>;
 
-		button-function {
+		key_f: button-function {
 			label = "Function";
 			linux,code = <KEY_FN>;
 			press-threshold-microvolt = <10000>;
@@ -64,7 +64,7 @@
 		compatible = "gpio-keys-polled";
 		poll-interval = <100>;
 
-		power-button {
+		key_p: power-button {
 			label = "power";
 			linux,code = <KEY_POWER>;
 			gpios = <&gpio_ao GPIOAO_2 GPIO_ACTIVE_LOW>;
diff --git a/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi b/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi
index ce2e8f1..48404bc 100644
--- a/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi
+++ b/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi
@@ -31,7 +31,7 @@
 		io-channel-names = "buttons";
 		keyup-threshold-microvolt = <1710000>;
 
-		button-function {
+		key_f: button-function {
 			label = "Function";
 			linux,code = <KEY_FN>;
 			press-threshold-microvolt = <10000>;
@@ -62,7 +62,7 @@
 		compatible = "gpio-keys-polled";
 		poll-interval = <100>;
 
-		power-button {
+		key_p: power-button {
 			label = "power";
 			linux,code = <KEY_POWER>;
 			gpios = <&gpio_ao GPIOAO_7 GPIO_ACTIVE_LOW>;
-- 
2.14.1

